<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRMFC Lagarto - Área do Residente</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração do Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 'sans': ['Inter', 'sans-serif'] },
                    colors: {
                        'blue-950': '#1C3D5A',
                        'blue-800': '#2D6FAD',
                        'gray-100': '#F4F7F6',
                    }
                }
            }
        }
    </script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Alpine.js (para o menu de navegação) -->
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- React + Babel (para a aplicação) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // SDKs do Firebase v10+
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, query, where, 
            addDoc, deleteDoc, onSnapshot 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Exponha as funções do Firebase para o script Babel
        window.firebase = {
            initializeApp,
            getAuth,
            onAuthStateChanged,
            signInWithEmailAndPassword,
            signOut,
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            collection,
            getDocs,
            query,
            where,
            addDoc,
            deleteDoc,
            onSnapshot // Adicionamos onSnapshot para real-time updates
        };
    </script>
    <style>
        [x-cloak] { display: none !important; }
        .loader {
            border-top-color: #2D6FAD;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="font-sans antialiased text-gray-800 bg-gray-100">

    <!-- Menu de Navegação (Consistente com as outras páginas) -->
    <nav class="bg-white shadow-md sticky top-0 z-50" x-data="{ open: false }">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex-shrink-0 flex items-center">
                    <a href="/mfc-lagarto/index.html" class="flex items-center space-x-2 text-xl font-bold text-blue-950">
                        <img class="h-8 w-auto" src="/mfc-lagarto/logo_mfc.png" alt="Logotipo PRMFC Lagarto" onerror="this.style.display='none'">
                        <span>PRMFC Lagarto</span>
                    </a>
                </div>
                <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                    <a href="/mfc-lagarto/index.html" class="inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">Início</a>
                    <a href="/mfc-lagarto/sobre.html" class="inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">Sobre</a>
                    <a href="/mfc-lagarto/programa.html" class="inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">O Programa</a>
                    <a href="/mfc-lagarto/contato.html" class="inline-flex items-center px-1 pt-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">Contato</a>
                    <!-- Link Destacado e Ativo -->
                    <a href="/mfc-lagarto/area-residente.html" class="my-auto inline-flex items-center px-4 py-1.5 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-950 hover:bg-blue-800 ring-2 ring-offset-2 ring-blue-800">
                        Área do Residente
                    </a>
                </div>
                <div class="-mr-2 flex items-center sm:hidden">
                    <button @click="open = !open" type="button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-blue-800" aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Abrir menu</span>
                        <svg x-show="!open" class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                        <svg x-show="open" class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true" x-cloak><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Menu Aberto (Mobile) -->
        <div class="sm:hidden" id="mobile-menu" x-show="open" x-cloak @click.away="open = false">
            <div class="pt-2 pb-3 space-y-1">
                <a href="/mfc-lagarto/index.html" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">Início</a>
                <a href="/mfc-lagarto/sobre.html" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">Sobre</a>
                <a href="/mfc-lagarto/programa.html" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">O Programa</a>
                <a href="/mfc-lagarto/contato.html" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-600 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-800">Contato</a>
                <a href="/mfc-lagarto/area-residente.html" class="block pl-3 pr-4 py-3 border-l-4 border-blue-800 text-base font-medium text-white bg-blue-800 hover:bg-blue-700">
                    Área do Residente
                </a>
            </div>
        </div>
    </nav>

    <!-- Ponto de Montagem do App React -->
    <div id="root" class="min-h-[80vh]"></div>

    <!-- Footer -->
    <footer class="bg-blue-950">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <p class="text-center text-sm text-blue-200">
                &copy; 2025 Programa de Residência em Medicina de Família e Comunidade - Lagarto/SE.
            </p>
        </div>
    </footer>


    <!-- 
      ============================================
      INÍCIO DA APLICAÇÃO REACT (via Babel)
      ============================================
    -->
    <script type="text/babel">
        // Importa funções do React
        const { useState, useEffect, useCallback, StrictMode } = React;
        // Importa funções do Firebase (expostas na window)
        const {
            initializeApp, getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut,
            getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, query, where,
            addDoc, deleteDoc, onSnapshot
        } = window.firebase;

        // ===========================================
        // 1. CONFIGURAÇÃO DO FIREBASE
        // ===========================================
        const firebaseConfig = {
          apiKey: "AIzaSyCm7rxloAIEBeh3_M8Cr8AptRyzPtlsCdc",
          authDomain: "prmfc-lagarto-site.firebaseapp.com",
          projectId: "prmfc-lagarto-site",
          storageBucket: "prmfc-lagarto-site.firebasestorage.app",
          messagingSenderId: "370143866875",
          appId: "1:370143866875:web:dbc0e91916675ede12255e",
          measurementId: "G-YQNS20DJFS"
        };
        
        // Inicializa o Firebase
        let firebase_app;
        let firestore_db;
        let firebase_auth;

        try {
            firebase_app = initializeApp(firebaseConfig);
            firestore_db = getFirestore(firebase_app);
            firebase_auth = getAuth(firebase_app);
        } catch (e) {
            console.error("Erro ao inicializar o Firebase:", e);
            if (e.code === 'invalid-api-key') {
                alert("Erro: A chave da API do Firebase não é válida. Verifique a configuração 'firebaseConfig' no arquivo area-residente.html.");
            }
        }

        // ===========================================
        // 2. COMPONENTE PRINCIPAL: App
        // ===========================================
        function App() {
            return (
                <StrictMode>
                    <AuthGate />
                </StrictMode>
            );
        }

        // ===========================================
        // 3. COMPONENTE: AuthGate (Portão de Autenticação)
        // ===========================================
        function AuthGate() {
            const [user, setUser] = useState(null); 
            const [userData, setUserData] = useState(null); 
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(firebase_auth, async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        try {
                            const userDocRef = doc(firestore_db, "users", currentUser.uid);
                            // MUDANÇA: Usamos onSnapshot para ouvir mudanças no
                            // documento do usuário em tempo real (ex: lotação)
                            const unsubDoc = onSnapshot(userDocRef, (userDocSnap) => {
                                if (userDocSnap.exists()) {
                                    setUserData(userDocSnap.data());
                                } else {
                                    console.error("Documento do usuário não encontrado!");
                                    signOut(firebase_auth);
                                }
                                setIsLoading(false);
                            });
                            // Retorna o listener do documento para limpar
                            return () => unsubDoc();

                        } catch (error) {
                            console.error("Erro ao buscar dados do usuário:", error);
                            setIsLoading(false);
                        }
                    } else {
                        setUser(null);
                        setUserData(null);
                        setIsLoading(false);
                    }
                });

                // Limpa o listener de autenticação
                return () => unsubscribe();
            }, []);

            if (isLoading) {
                return <Loader message="Carregando..." />;
            }

            if (user && userData) {
                return <Dashboard user={user} userData={userData} />;
            }

            return <LoginScreen />;
        }

        // ===========================================
        // 4. COMPONENTE: LoginScreen
        // (Sem mudanças, igual ao anterior)
        // ===========================================
        function LoginScreen() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [isLoading, setIsLoading] = useState(false);

            const handleLogin = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');
                try {
                    await signInWithEmailAndPassword(firebase_auth, email, password);
                } catch (error) {
                    console.error("Erro no login:", error.code);
                    if (error.code === 'auth/invalid-credential') {
                        setError('E-mail ou senha inválidos.');
                    } else {
                        setError('Ocorreu um erro ao tentar logar.');
                    }
                    setIsLoading(false);
                }
            };

            return (
                <div className="flex items-center justify-center py-20 bg-gray-100">
                    <div className="max-w-md w-full bg-white p-8 rounded-lg shadow-lg">
                        <div className="text-center">
                            <img className="h-12 w-auto mx-auto" src="/mfc-lagarto/logo_mfc.png" alt="Logotipo PRMFC Lagarto" />
                            <h2 className="mt-4 text-2xl font-bold text-blue-950">Área do Residente</h2>
                            <p className="mt-2 text-gray-600">Acesso restrito para residentes e coordenação.</p>
                        </div>
                        <form className="mt-8 space-y-6" onSubmit={handleLogin}>
                            <div>
                                <label htmlFor="email" className="block text-sm font-medium text-gray-700">E-mail</label>
                                <input
                                    type="email"
                                    id="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-800 focus:border-blue-800"
                                />
                            </div>
                            <div>
                                <label htmlFor="password" class="block text-sm font-medium text-gray-700">Senha</label>
                                <input
                                    type="password"
                                    id="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                    className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-800 focus:border-blue-800"
                                />
                            </div>
                            
                            {error && <p className="text-sm text-red-600 text-center">{error}</p>}
                            
                            <div>
                                <button
                                    type="submit"
                                    disabled={isLoading}
                                    className="w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-800 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-800 disabled:bg-gray-400"
                                >
                                    {isLoading ? 'Entrando...' : 'Entrar'}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // ===========================================
        // 5. COMPONENTE: Dashboard
        // ===========================================
        function Dashboard({ user, userData }) {
            const handleLogout = async () => {
                try {
                    await signOut(firebase_auth);
                } catch (error) {
                    console.error("Erro ao deslogar:", error);
                }
            };

            return (
                <div className="container mx-auto px-4 sm:px-6 lg:px-8 py-12 max-w-7xl">
                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <h1 className="text-2xl font-bold text-blue-950">\Olá, {userData.nome}</h1>
                            {/* MUDANÇA: Passamos o userData para o painel de residente */}
                            <p className="text-gray-600">
                                {userData.role === 'coord' ? 'Painel de Coordenação' : 'Painel do Residente'}
                            </p>
                        </div>
                        <button
                            onClick={handleLogout}
                            className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-950 hover:bg-blue-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-800"
                        >
                            Sair
                        </button>
                    </header>
                    
                    <main>
                        {userData.role === 'coord' ? (
                            <CoordDashboard />
                        ) : (
                            // MUDANÇA: Passamos o objeto `userData` inteiro
                            <ResidenteDashboard user={user} userData={userData} />
                        )}
                    </main>
                </div>
            );
        }

        // ===========================================
        // 6. COMPONENTE: ResidenteDashboard
        // (Grandes mudanças aqui!)
        // ===========================================
        function ResidenteDashboard({ user, userData }) {
            const [agenda, setAgenda] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            // Função para formatar data YYYY-MM-DD para DD/MM/YYYY
            const formatarData = (isoDate) => {
                const [ano, mes, dia] = isoDate.split('-');
                return `${dia}/${mes}/${ano}`;
            };
            
            // Função para pegar data de hoje em YYYY-MM-DD
            const getHoje = () => {
                 return new Date().toISOString().split('T')[0];
            };

            useEffect(() => {
                setIsLoading(true);
                // MUDANÇA: Consultamos a nova coleção 'agendas'
                const q = query(
                    collection(firestore_db, "agendas"), 
                    where("userId", "==", user.uid)
                );
                
                // Usamos onSnapshot para ouvir em tempo real
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const agendaDoUsuario = [];
                    querySnapshot.forEach((doc) => {
                        agendaDoUsuario.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Ordena por data de início
                    agendaDoUsuario.sort((a, b) => new Date(a.dataInicio) - new Date(b.dataInicio));
                    
                    setAgenda(agendaDoUsuario);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Erro ao buscar agenda: ", error);
                    setIsLoading(false);
                });

                return () => unsubscribe(); // Limpa o listener
            }, [user.uid]);

            if (isLoading) {
                return <Loader message="Carregando agenda..." />;
            }
            
            // MUDANÇA: Lógica de automação de atividades
            const hoje = getHoje();
            const atividadesAtuais = agenda.filter(item => 
                item.dataInicio <= hoje && item.dataFim >= hoje
            );
            const atividadesFuturas = agenda.filter(item => 
                item.dataInicio > hoje
            );
            // Atividades passadas são simplesmente ignoradas (não são filtradas)

            return (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    {/* Coluna de Atividades */}
                    <div className="bg-white p-8 rounded-lg shadow-lg">
                        {/* MUDANÇA: Exibe a lotação */}
                        <p className="text-lg font-semibold text-blue-800 -mt-2 mb-6">
                            Lotação: {userData.lotacaoESF || "Não definida"}
                        </p>

                        <div>
                            <h4 className="font-semibold text-gray-800 text-xl">Atividades atuais</h4>
                            {atividadesAtuais.length > 0 ? (
                                <ul className="mt-3 space-y-3">
                                    {atividadesAtuais.map(item => (
                                        <li key={item.id} className="p-4 bg-blue-50 rounded-md shadow-sm">
                                            <p className="font-semibold text-blue-900">{item.nome}</p>
                                            <p className="text-sm text-gray-600">
                                                Até: {formatarData(item.dataFim)}
                                            </p>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <p className="mt-2 text-gray-500 bg-gray-50 p-4 rounded-md">
                                    Nenhuma atividade no momento.
                                </p>
                            )}
                        </div>
                        
                        <div className="mt-8">
                            <h4 className="font-semibold text-gray-800 text-xl">Atividades futuras</h4>
                            {atividadesFuturas.length > 0 ? (
                                <ul className="mt-3 space-y-3">
                                    {atividadesFuturas.slice(0, 5).map(item => ( // Mostra só as próximas 5
                                        <li key={item.id} className="p-3 bg-gray-100 rounded-md">
                                            <span className="font-medium text-blue-800">
                                                {formatarData(item.dataInicio)}
                                                {item.dataFim !== item.dataInicio && ` a ${formatarData(item.dataFim)}`}
                                            </span>
                                            <p className="text-sm text-gray-700">{item.nome}</p>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <p className="mt-2 text-gray-500">Nenhuma atividade futura agendada.</p>
                            )}
                        </div>
                    </div>
                    
                    {/* Coluna de Materiais */}
                    <div className="bg-white p-8 rounded-lg shadow-lg">
                        <h3 className="text-xl font-semibold text-blue-950 mb-6">Materiais para download</h3>
                        <p className="text-sm text-gray-600 mb-4">(Esta seção ainda é um placeholder. Requer o Firebase Storage.)</p>
                        <ul className="space-y-3">
                            <li><a href="#" className="text-blue-800 hover:underline">Modelo de Portfólio.docx</a></li>
                            <li><a href="#" className="text-blue-800 hover:underline">Protocolo de Saúde da Mulher.pdf</a></li>
                        </ul>
                    </div>
                </div>
            );
        }

        // ===========================================
        // 7. COMPONENTE: CoordDashboard
        // ===========================================
        
        // Lista de atividades predefinidas
        const atividadesDisponiveis = [
            { nome: "Estágio na eSF (Lotação)", tipo: "estagio" },
            { nome: "Estágio: Urgência e Emergência (Colônia Treze)", tipo: "estagio" },
            { nome: "Estágio: Ambulatório de Psiquiatria (UFS)", tipo: "estagio" },
            { nome: "Estágio: Pronto-Socorro de Pediatria (HUL)", tipo: "estagio" },
            { nome: "Estágio: Ambulatório de Saúde Trans (UFS)", tipo: "estagio" },
            { nome: "Estágio: Pré-Natal de Alto Risco (UFS)", tipo: "estagio" },
            { nome: "Estágio: Pequenos Procedimentos (HUL)", tipo: "estagio" },
            { nome: "Apresentação: Encontro Quinzenal", tipo: "pontual" },
            { nome: "Participação: Webinar SBMFC", tipo: "pontual" },
            { nome: "Entrega: Portfólio Mensal", tipo: "pontual" },
            { nome: "Férias", tipo: "estagio" },
            { nome: "Outro (Descrever)", tipo: "pontual" },
        ];


        function CoordDashboard() {
            const [residentes, setResidentes] = useState([]);
            const [selectedResidente, setSelectedResidente] = useState(null); // Guarda o obj {uid, nome, lotacaoESF}
            const [agendaSelecionada, setAgendaSelecionada] = useState([]);
            
            const [isLoadingResidentes, setIsLoadingResidentes] = useState(true);
            const [isLoadingAgenda, setIsLoadingAgenda] = useState(false);
            
            // Estados do formulário
            const [novaLotacao, setNovaLotacao] = useState('');
            const [isSavingLotacao, setIsSavingLotacao] = useState(false);
            
            // Estados do formulário da agenda
            const [atividadeAgendada, setAtividadeAgendada] = useState(atividadesDisponiveis[0].nome);
            const [dataInicio, setDataInicio] = useState(new Date().toISOString().split('T')[0]);
            const [dataFim, setDataFim] = useState(new Date().toISOString().split('T')[0]);
            const [isSavingAgenda, setIsSavingAgenda] = useState(false);

            const [message, setMessage] = useState('');

            // 1. Busca todos os residentes na inicialização
            useEffect(() => {
                const q = query(collection(firestore_db, "users"), where("role", "==", "residente"));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const residentesList = querySnapshot.docs.map(doc => ({
                        uid: doc.id,
                        ...doc.data()
                    }));
                    setResidentes(residentesList);
                    setIsLoadingResidentes(false);
                }, (error) => {
                    console.error("Erro ao buscar residentes:", error);
                    setIsLoadingResidentes(false);
                });
                return () => unsubscribe();
            }, []);

            // 2. Busca agenda quando um residente é selecionado
            useEffect(() => {
                if (!selectedResidente?.uid) {
                    setAgendaSelecionada([]);
                    return;
                }
                
                setIsLoadingAgenda(true);
                const q = query(
                    collection(firestore_db, "agendas"), 
                    where("userId", "==", selectedResidente.uid)
                );
                
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    let agenda = [];
                    querySnapshot.forEach(doc => agenda.push({ id: doc.id, ...doc.data() }));
                    // Ordena por data de início
                    agenda.sort((a, b) => new Date(a.dataInicio) - new Date(b.dataInicio));
                    setAgendaSelecionada(agenda);
                    setIsLoadingAgenda(false);
                }, (error) => {
                    console.error("Erro ao buscar agenda selecionada:", error);
                    setIsLoadingAgenda(false);
                });

                return () => unsubscribe();
            }, [selectedResidente]);

            const handleSelectChange = (e) => {
                const uid = e.target.value;
                if (uid) {
                    const res = residentes.find(r => r.uid === uid);
                    setSelectedResidente(res);
                    setNovaLotacao(res.lotacaoESF || '');
                } else {
                    setSelectedResidente(null);
                    setNovaLotacao('');
                }
            };
            
            const showMessage = (msg) => {
                setMessage(msg);
                setTimeout(() => setMessage(''), 3000);
            };

            // 3. Salvar Lotação
            const handleSaveLotacao = async (e) => {
                e.preventDefault();
                if (!selectedResidente) return;
                
                setIsSavingLotacao(true);
                try {
                    const userDocRef = doc(firestore_db, "users", selectedResidente.uid);
                    await updateDoc(userDocRef, {
                        lotacaoESF: novaLotacao
                    });
                    showMessage("Lotação salva com sucesso!");
                } catch (error) {
                    console.error("Erro ao salvar lotação:", error);
                    showMessage("Erro ao salvar lotação.");
                }
                setIsSavingLotacao(false);
            };

            // 4. Agendar Nova Atividade
            const handleAgendar = async (e) => {
                e.preventDefault();
                if (!selectedResidente) return;

                // Validação de datas
                if (dataFim < dataInicio) {
                    showMessage("A data final não pode ser anterior à data inicial.");
                    return;
                }
                
                setIsSavingAgenda(true);
                try {
                    const tipoAtividade = atividadesDisponiveis.find(a => a.nome === atividadeAgendada)?.tipo || 'pontual';
                    
                    await addDoc(collection(firestore_db, "agendas"), {
                        userId: selectedResidente.uid,
                        nome: atividadeAgendada,
                        tipo: tipoAtividade,
                        dataInicio: dataInicio,
                        dataFim: tipoAtividade === 'pontual' ? dataInicio : dataFim, // Se for pontual, data fim = data início
                    });
                    
                    showMessage("Atividade agendada com sucesso!");
                    // Resetar campos
                    setDataInicio(new Date().toISOString().split('T')[0]);
                    setDataFim(new Date().toISOString().split('T')[0]);

                } catch (error) {
                    console.error("Erro ao agendar:", error);
                    showMessage("Erro ao agendar atividade.");
                }
                setIsSavingAgenda(false);
            };

            // 5. Deletar Atividade
            const handleDeleteAtividade = async (id) => {
                if (!window.confirm("Tem certeza que deseja remover esta atividade?")) return;
                
                try {
                    await deleteDoc(doc(firestore_db, "agendas", id));
                    showMessage("Atividade removida.");
                } catch (error) {
                    console.error("Erro ao remover:", error);
                    showMessage("Erro ao remover atividade.");
                }
            };

            if (isLoadingResidentes) {
                return <Loader message="Carregando lista de residentes..." />;
            }
            
            // Função para formatar data YYYY-MM-DD para DD/MM
            const formatarDataCurta = (isoDate) => {
                const [ano, mes, dia] = isoDate.split('-');
                return `${dia}/${mes}`;
            };
            const hoje = new Date().toISOString().split('T')[0];

            return (
                <div className="bg-white p-8 rounded-lg shadow-lg">
                    <h3 className="text-xl font-semibold text-blue-950 mb-6">Painel de Coordenação</h3>
                    
                    {/* Seletor de Residente */}
                    <div className="mb-6">
                        <label htmlFor="residente-select" className="block text-sm font-medium text-gray-700">Selecione o Residente</label>
                        <select
                            id="residente-select"
                            onChange={handleSelectChange}
                            className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-800 focus:border-blue-800 sm:text-sm rounded-md"
                        >
                            <option value="">-- Selecione --</option>
                            {residentes.map(res => (
                                <option key={res.uid} value={res.uid}>{res.nome}</option>
                            ))}
                        </select>
                    </div>

                    {/* Formulários e Listas (só aparecem se um residente for selecionado) */}
                    {selectedResidente && (
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
                            
                            {/* Coluna Esquerda: Gerenciamento */}
                            <div className="space-y-8">
                                
                                {/* Gerenciar Lotação */}
                                <form onSubmit={handleSaveLotacao} className="space-y-3">
                                    <h4 className="text-lg font-semibold text-gray-800">Gerenciar Lotação</h4>
                                    <div>
                                        <label htmlFor="lotacao" className="block text-sm font-medium text-gray-700">Lotação na eSF</label>
                                        <input
                                            type="text"
                                            id="lotacao"
                                            value={novaLotacao}
                                            onChange={(e) => setNovaLotacao(e.target.value)}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-800 focus:border-blue-800"
                                        />
                                    </div>
                                    <button
                                        type="submit"
                                        disabled={isSavingLotacao}
                                        className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-800 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-800 disabled:bg-gray-400"
                                    >
                                        {isSavingLotacao ? 'Salvando...' : 'Salvar Lotação'}
                                    </button>
                                </form>

                                {/* Agendar Atividade */}
                                <form onSubmit={handleAgendar} className="space-y-3">
                                    <h4 className="text-lg font-semibold text-gray-800">Agendar Atividade</h4>
                                    <div>
                                        <label htmlFor="atividade-select" className="block text-sm font-medium text-gray-700">Atividade</label>
                                        <select
                                            id="atividade-select"
                                            value={atividadeAgendada}
                                            onChange={(e) => setAtividadeAgendada(e.target.value)}
                                            className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-800 focus:border-blue-800 sm:text-sm rounded-md"
                                        >
                                            {atividadesDisponiveis.map(at => (
                                                <option key={at.nome} value={at.nome}>{at.nome}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label htmlFor="data-inicio" className="block text-sm font-medium text-gray-700">Data Início</label>
                                            <input type="date" id="data-inicio" value={dataInicio} onChange={e => setDataInicio(e.target.value)}
                                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-800 focus:border-blue-800" />
                                        </div>
                                        <div>
                                            <label htmlFor="data-fim" className="block text-sm font-medium text-gray-700">Data Fim</label>
                                            <input type="date" id="data-fim" value={dataFim} onChange={e => setDataFim(e.target.value)}
                                                className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-800 focus:border-blue-800" />
                                        </div>
                                    </div>
                                    <button
                                        type="submit"
                                        disabled={isSavingAgenda}
                                        className="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-700 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-600 disabled:bg-gray-400"
                                    >
                                        {isSavingAgenda ? 'Agendando...' : 'Agendar'}
                                    </button>
                                </form>

                            </div>

                            {/* Coluna Direita: Agenda Atual */}
                            <div>
                                <h4 className="text-lg font-semibold text-gray-800 mb-3">Agenda de {selectedResidente.nome}</h4>
                                {message && <p className="text-sm text-green-600 mb-3">{message}</p>}
                                
                                {isLoadingAgenda ? (
                                    <p>Carregando agenda...</p>
                                ) : (
                                    <ul className="space-y-2 h-96 overflow-y-auto pr-2">
                                        {agendaSelecionada.length === 0 && <p className="text-gray-500">Nenhuma atividade agendada.</p>}
                                        
                                        {agendaSelecionada.map(item => (
                                            <li 
                                                key={item.id} 
                                                className={`flex items-center justify-between p-3 rounded-md 
                                                    ${item.dataFim < hoje ? 'bg-gray-100 opacity-60' : ''} 
                                                    ${item.dataInicio <= hoje && item.dataFim >= hoje ? 'bg-blue-50 border border-blue-200' : 'bg-gray-50'}`}
                                            >
                                                <div>
                                                    <p className="font-medium text-gray-800 text-sm">{item.nome}</p>
                                                    <p className="text-xs text-blue-800">
                                                        {formatarDataCurta(item.dataInicio)}
                                                        {item.dataFim !== item.dataInicio && ` a ${formatarDataCurta(item.dataFim)}`}
                                                    </p>
                                                </div>
                                                <button 
                                                    onClick={() => handleDeleteAtividade(item.id)}
                                                    className="text-red-500 hover:text-red-700 text-sm font-medium"
                                                >
                                                    Remover
                                                </button>
                                            </li>
                                        ))}
                                    </ul>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ===========================================
        // 8. COMPONENTE UTILITÁRIO: Loader
        // ===========================================
        function Loader({ message }) {
            return (
                <div className="flex flex-col items-center justify-center min-h-[50vh] text-center">
                    <div className="loader w-12 h-12 rounded-full border-4 border-gray-200"></div>
                    <p className="mt-4 text-lg text-gray-600">{message || "Carregando..."}</p>
                </div>
            );
        }

        // ===========================================
        // 9. RENDERIZA A APLICAÇÃO
        // ===========================================
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
    <!-- FIM DA APLICAÇÃO REACT -->

</body>
</html>
